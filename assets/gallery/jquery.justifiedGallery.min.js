/*!
 * Justified Gallery - v3.2.0
 * http://miromannino.com/projects/justified-gallery/
 * Copyright (c) 2014 Miro Mannino
 * Licensed under the MIT license.
 */
!(function(e){e.fn.justifiedGallery=function(t){function r(e,t,n){var r;r=e>t?e:t;if(r<=100){return n.settings.sizeRangeSuffixes.lt100}else if(r<=240){return n.settings.sizeRangeSuffixes.lt240}else if(r<=320){return n.settings.sizeRangeSuffixes.lt320}else if(r<=500){return n.settings.sizeRangeSuffixes.lt500}else if(r<=640){return n.settings.sizeRangeSuffixes.lt640}else{return n.settings.sizeRangeSuffixes.lt1024}}function i(t){var n=e(t.currentTarget).find(".sgg-caption");if(t.data.settings.cssAnimation){n.addClass("caption-visible").removeClass("caption-hidden")}else{n.stop().fadeTo(t.data.settings.captionsAnimationDuration,t.data.settings.captionsVisibleOpacity)}}function s(t){var n=e(t.currentTarget).find(".sgg-caption");if(t.data.settings.cssAnimation){n.removeClass("caption-visible").removeClass("caption-hidden")}else{n.stop().fadeTo(t.data.settings.captionsAnimationDuration,0)}}function o(t,n,o,u,a,f,l){var c=t.find("img");c.css("width",u);c.css("height",a);c.css("margin-left",-u/2);c.css("margin-top",-a/2);t.width(u);t.height(f);t.css("top",o);t.css("left",n);var h=c.attr("src");var p=h.replace(l.settings.extension,"").replace(l.usedSizeRangeRegExp,"")+r(u,a,l)+h.match(l.settings.extension)[0];c.one("error",function(){c.attr("src",c.data("jg.originalSrc"))});var d=function(){if(h!==p){c.attr("src",p)}};if(l.settings.cssAnimation){t.addClass("entry-visible");d()}else{t.stop().fadeTo(l.settings.imagesAnimationDuration,1,d)}var v=t.data("jg.captionMouseEvents");if(l.settings.captions===true){var m=t.find(".sgg-caption");if(m.length===0){var g=c.attr("alt");if(typeof g==="undefined")g=t.attr("title");if(typeof g!=="undefined"){m=e('<div class="sgg-caption"><span>'+g+"</span></div>");t.append(m)}}if(m.length!==0&&typeof v==="undefined"){v={mouseenter:i,mouseleave:s};t.on("mouseenter",undefined,l,v.mouseenter);t.on("mouseleave",undefined,l,v.mouseleave);t.data("jg.captionMouseEvents",v)}}else{if(typeof v!=="undefined"){t.off("mouseenter",undefined,l,v.mouseenter);t.off("mouseleave",undefined,l,v.mouseleave);t.removeData("jg.captionMouseEvents")}}}function u(e,t){var n,r,i,s,o,u,a=true;var f=0;var l=e.galleryWidth;var c=l-e.buildingRow.width-(e.buildingRow.entriesBuff.length-1)*e.settings.margins;if(t&&e.settings.lastRow==="hide"&&c/l>e.settings.justifyThreshold){for(n=0;n<e.buildingRow.entriesBuff.length;n++){r=e.buildingRow.entriesBuff[n];if(e.settings.cssAnimation)r.removeClass("entry-visible");else r.stop().fadeTo(0,0)}return-1}if(t&&e.settings.lastRow==="nojustify"&&c/l>e.settings.justifyThreshold)a=false;for(n=0;n<e.buildingRow.entriesBuff.length;n++){i=e.buildingRow.entriesBuff[n].find("img");s=Math.ceil(i.data("jg.imgw")/(i.data("jg.imgh")/e.settings.rowHeight));if(a){if(n<e.buildingRow.entriesBuff.length-1){o=s+Math.ceil(s/e.buildingRow.width*c)}else{o=l}u=Math.ceil(e.settings.rowHeight*(o/s));if(e.settings.fixedHeight&&u<e.settings.rowHeight){o=s;u=e.settings.rowHeight}}else{o=s;u=e.settings.rowHeight}i.data("jg.imgw",o);i.data("jg.imgh",u);l-=o+(n<e.buildingRow.entriesBuff.length-1?e.settings.margins:0);if(n===0||f>u)f=u}if(e.settings.fixedHeight)f=e.settings.rowHeight;return f}function a(e){e.lastAnalyzedIndex=-1;e.buildingRow.entriesBuff=[];e.buildingRow.width=0;e.offY=0;e.firstRowFlushed=false}function f(e,t){var n,r,i,s=0;i=u(e,t);if(t&&e.settings.lastRow==="hide"&&i===-1){e.buildingRow.entriesBuff=[];e.buildingRow.width=0;return}if(e.settings.maxRowHeight>0&&e.settings.maxRowHeight<i)i=e.settings.maxRowHeight;else if(e.settings.maxRowHeight===0&&1.5*e.settings.rowHeight<i)i=1.5*e.settings.rowHeight;for(var a=0;a<e.buildingRow.entriesBuff.length;a++){n=e.buildingRow.entriesBuff[a];r=n.find("img");o(n,s,e.offY,r.data("jg.imgw"),r.data("jg.imgh"),i,e);s+=r.data("jg.imgw")+e.settings.margins}e.$gallery.height(e.offY+i+(e.spinner.active?e.spinner.$el.innerHeight():0));if(!t){e.offY+=i+e.settings.margins;e.buildingRow.entriesBuff=[];e.buildingRow.width=0;e.firstRowFlushed=true;e.$gallery.trigger("jg.rowflush")}}function l(e){e.checkWidthIntervalId=setInterval(function(){var t=parseInt(e.$gallery.width(),10);if(e.galleryWidth!==t){e.galleryWidth=t;a(e);d(e,true)}},e.settings.refreshTime)}function c(e){clearInterval(e.intervalId);e.intervalId=setInterval(function(){if(e.phase<e.$points.length)e.$points.eq(e.phase).fadeTo(e.timeslot,1);else e.$points.eq(e.phase-e.$points.length).fadeTo(e.timeslot,0);e.phase=(e.phase+1)%(e.$points.length*2)},e.timeslot)}function h(e){clearInterval(e.intervalId);e.intervalId=null}function p(e){e.yield.flushed=0;if(e.imgAnalyzerTimeout!==null)clearTimeout(e.imgAnalyzerTimeout)}function d(e,t){p(e);e.imgAnalyzerTimeout=setTimeout(function(){v(e,t)},.001);v(e,t)}function v(t,n){var r;for(var i=t.lastAnalyzedIndex+1;i<t.entries.length;i++){var s=e(t.entries[i]);var o=s.find("img");if(o.data("jg.loaded")===true){var u=Math.ceil(o.data("jg.imgw")/(o.data("jg.imgh")/t.settings.rowHeight));r=t.firstRowFlushed&&i>=t.entries.length-1;if(t.buildingRow.width+(t.settings.fixedHeight?u:u/2)+(t.buildingRow.entriesBuff.length-1)*t.settings.margins>t.galleryWidth){f(t,r);if(++t.yield.flushed>=t.yield.every){d(t,n);return}}t.buildingRow.entriesBuff.push(s);t.buildingRow.width+=u;t.lastAnalyzedIndex=i}else if(o.data("jg.loaded")!=="error"){return}}if(t.buildingRow.entriesBuff.length>0)f(t,t.firstRowFlushed);if(t.spinner.active){t.spinner.active=false;t.$gallery.height(t.$gallery.height()-t.spinner.$el.innerHeight());t.spinner.$el.detach();h(t.spinner)}p(t);if(!n)t.$gallery.trigger("jg.complete");else t.$gallery.trigger("jg.resize")}function m(e){function t(t){if(typeof e.settings.sizeRangeSuffixes[t]!=="string")throw"sizeRangeSuffixes."+t+" must be a string"}function n(t){if(typeof e.settings[t]==="string"){e.settings[t]=parseFloat(e.settings[t],10);if(isNaN(e.settings[t]))throw"invalid number for "+t}else if(typeof e.settings[t]==="number"){if(isNaN(e.settings[t]))throw"invalid number for "+t}else{throw t+" must be a number"}}if(typeof e.settings.sizeRangeSuffixes!=="object")throw"sizeRangeSuffixes must be defined and must be an object";t("lt100");t("lt240");t("lt320");t("lt500");t("lt640");t("lt1024");n("rowHeight");n("maxRowHeight");n("margins");if(e.settings.lastRow!=="nojustify"&&e.settings.lastRow!=="justify"&&e.settings.lastRow!=="hide"){throw'lastRow must be "nojustify", "justify" or "hide"'}n("justifyThreshold");if(e.settings.justifyThreshold<0||e.settings.justifyThreshold>1)throw"justifyThreshold must be in the interval [0,1]";if(typeof e.settings.cssAnimation!=="boolean"){throw"cssAnimation must be a boolean"}n("captionsAnimationDuration");n("imagesAnimationDuration");n("captionsVisibleOpacity");if(e.settings.captionsVisibleOpacity<0||e.settings.captionsVisibleOpacity>1)throw"captionsVisibleOpacity must be in the interval [0,1]";if(typeof e.settings.fixedHeight!=="boolean"){throw"fixedHeight must be a boolean"}if(typeof e.settings.captions!=="boolean"){throw"captions must be a boolean"}n("refreshTime");if(typeof e.settings.randomize!=="boolean"){throw"randomize must be a boolean"}}var n={sizeRangeSuffixes:{lt100:"_t",lt240:"_m",lt320:"_n",lt500:"",lt640:"_z",lt1024:"_b"},rowHeight:120,maxRowHeight:0,margins:1,lastRow:"nojustify",justifyThreshold:.35,cssAnimation:false,captionsAnimationDuration:500,captionsVisibleOpacity:.7,imagesAnimationDuration:300,fixedHeight:false,captions:true,rel:null,target:null,extension:/\.[^.]+$/,refreshTime:250,randomize:false};return this.each(function(r,i){var s=e(i);s.addClass("justified-gallery");var o=s.data("jg.context");if(typeof o==="undefined"){if(typeof t!=="undefined"&&t!==null&&typeof t!=="object")throw"The argument must be an object";var u=e('<div class="spinner"><span></span><span></span><span></span></div>');o={settings:e.extend({},n,t),imgAnalyzerTimeout:null,entries:null,buildingRow:{entriesBuff:[],width:0},lastAnalyzedIndex:-1,firstRowFlushed:false,yield:{every:2,flushed:0},offY:0,spinner:{active:false,phase:0,timeslot:150,$el:u,$points:u.find("span"),intervalId:null},checkWidthIntervalId:null,galleryWidth:s.width(),$gallery:s};s.data("jg.context",o)}else if(t==="norewind"){}else{o.settings=e.extend({},o.settings,t);a(o)}m(o);o.entries=s.find("> a, > div").toArray();if(o.entries.length===0)return;if(o.settings.randomize){o.entries.sort(function(){return Math.random()*2-1});e.each(o.entries,function(){e(this).appendTo(s)})}o.usedSizeRangeRegExp=new RegExp("("+o.settings.sizeRangeSuffixes.lt100+"|"+o.settings.sizeRangeSuffixes.lt240+"|"+o.settings.sizeRangeSuffixes.lt320+"|"+o.settings.sizeRangeSuffixes.lt500+"|"+o.settings.sizeRangeSuffixes.lt640+"|"+o.settings.sizeRangeSuffixes.lt1024+")$");if(o.settings.maxRowHeight>0&&o.settings.maxRowHeight<o.settings.rowHeight)o.settings.maxRowHeight=o.settings.rowHeight;var f=false;e.each(o.entries,function(t,n){var r=e(n);var i=r.find("img");if(i.data("jg.loaded")!==true){i.data("jg.loaded",false);f=true;if(o.spinner.active===false){o.spinner.active=true;s.append(o.spinner.$el);s.height(o.offY+o.spinner.$el.innerHeight());c(o.spinner)}if(o.settings.rel!==null)r.attr("rel",o.settings.rel);if(o.settings.target!==null)r.attr("target",o.settings.target);var u=typeof i.data("safe-src")!=="undefined"?i.data("safe-src"):i.attr("src");i.data("jg.originalSrc",u);i.attr("src",u);var a=new Image;var l=e(a);l.one("load",function(){i.off("load error");i.data("jg.imgw",a.width);i.data("jg.imgh",a.height);i.data("jg.loaded",true);d(o,false)});l.one("error",function(){i.off("load error");i.data("jg.loaded","error");d(o,false)});a.src=u}});if(!f)d(o,false);l(o)})}})(jQuery)